<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MERCHANDISER LOG</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#4f46e5" />

  <style>
    :root{
      --bg:#eef2f7;
      --card:#ffffff;
      --shadow:0 18px 40px rgba(15, 23, 42, .14);
      --text:#0f172a;
      --muted:#64748b;

      --brand:#4f46e5;
      --brandDark:#4338ca;

      --green:#16a34a;
      --greenDark:#15803d;

      --red:#ef4444;
      --redDark:#dc2626;

      --blue:#60a5fa;      /* světle modrá */
      --blueDark:#3b82f6;

      --yellow:#fbbf24;    /* žlutá */
      --yellowDark:#f59e0b;

      --gray:#9ca3af;
      --grayDark:#6b7280;

      --navy:#111827;
      --navyDark:#0b1220;

      --line:#e5e7eb;
      --radius:18px;
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      display:flex;
      justify-content:center;
      padding:24px 14px;
    }
    .phone{ width:min(430px, 100%); }
    .card{
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.06);
    }
    .header{
      background: var(--brand);
      padding: 22px 18px 18px;
      text-align:center;
      color:#fff;
    }
    .title{
      font-weight: 900;
      letter-spacing: .5px;
      font-size: 22px;
      margin:0 0 8px;
    }
    .now{ margin:0; opacity:.95; font-weight: 700; font-size: 14px; }
    .pill{
      display:inline-block;
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,.35);
      border: 1px solid rgba(255,255,255,.25);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .25px;
      text-transform: uppercase;
    }

    .content{ padding: 16px 18px 18px; }
    .sectionTitle{
      font-size: 12px;
      font-weight: 900;
      color: #7c8697;
      letter-spacing: 1px;
      margin: 10px 2px 10px;
      text-transform: uppercase;
    }
    .row{ display:flex; gap: 14px; }
    .btn{
      border:0;
      border-radius: 12px;
      padding: 14px 12px;
      font-weight: 900;
      font-size: 15px;
      width:100%;
      color:#fff;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(2,6,23,.10);
      transition: transform .05s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    .green{ background: var(--green); }
    .green:active{ background: var(--greenDark); }

    .red{ background: var(--red); }
    .red:active{ background: var(--redDark); }

    .blue{ background: var(--blue); color:#0b1220; }
    .blue:active{ background: var(--blueDark); color:#fff; }

    .yellow{ background: var(--yellow); color:#0b1220; }
    .yellow:active{ background: var(--yellowDark); color:#fff; }

    .gray{ background: var(--gray); }
    .gray:active{ background: var(--grayDark); }

    .navy{ background: var(--navy); }
    .navy:active{ background: var(--navyDark); }

    .divider{ height:1px; background: var(--line); margin: 14px 0; }

    .fieldRow{ display:flex; gap: 12px; align-items:center; margin-top: 6px; }
    .input{
      width:100%;
      border-radius: 12px;
      border: 1px solid #d8dee9;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    .input:focus{
      border-color: rgba(79,70,229,.45);
      box-shadow: 0 0 0 3px rgba(79,70,229,.15);
    }

    .status{
      padding: 10px 12px;
      background: #f8fafc;
      border: 1px solid #e7edf6;
      border-radius: 14px;
      font-size: 12px;
      color: #334155;
      font-weight: 800;
    }

    .activity{ margin-top: 10px; padding-bottom: 6px; }
    .item{
      border: 1px solid #e7edf6;
      background: #fbfdff;
      border-radius: 14px;
      padding: 10px 12px;
      margin-top: 8px;
    }
    .itemTop{ display:flex; justify-content:space-between; gap: 12px; align-items:flex-start; }
    .tag{
      font-weight: 900;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(79,70,229,.10);
      color: var(--brandDark);
      white-space:nowrap;
    }
    .itemTitle{ font-weight: 900; font-size: 14px; margin:0; }
    .itemSub{ margin: 4px 0 0; color: var(--muted); font-size: 12px; font-weight: 800; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .tiny{ font-size: 11px; color: var(--muted); font-weight: 800; }

    .exportBar{ display:flex; gap: 10px; align-items:center; margin-top: 8px; }
    .month{
      width: 150px;
      min-width: 150px;
      border-radius: 12px;
      border: 1px solid #d8dee9;
      padding: 12px 10px;
      font-weight: 900;
      font-size: 13px;
      background:#fff;
      color:var(--text);
      outline:none;
    }

    /* MODAL */
    .modalBack{
      position: fixed; inset:0;
      background: rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal{
      width: min(420px, 100%);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 30px 70px rgba(0,0,0,.22);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.08);
    }
    .modalHead{
      padding: 14px 14px 10px;
      background: #f8fafc;
      border-bottom: 1px solid #e7edf6;
      font-weight: 1000;
    }
    .modalBody{ padding: 14px; }
    .modalMsg{
      margin:0;
      font-size: 14px;
      font-weight: 800;
      color:#0f172a;
      line-height: 1.4;
    }
    .modalActions{
      display:flex;
      gap: 10px;
      padding: 14px;
      border-top: 1px solid #e7edf6;
      background: #fff;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="card">
      <div class="header">
        <h1 class="title">MERCHANDISER LOG</h1>
        <p class="now mono" id="nowText">--</p>
        <div class="pill" id="modePill">MIMO PRACOVNÍ DOBU</div>
      </div>

      <div class="content">
        <div class="sectionTitle">PRACOVNÍ SMĚNA</div>
        <div class="row">
          <button class="btn green" id="btnShiftStart">PŘÍCHOD</button>
          <button class="btn red" id="btnShiftEnd">ODCHOD</button>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">NÁVŠTĚVA PRODEJNY</div>
        <div class="fieldRow">
          <input class="input" id="storeName" placeholder="Název prodejny (např. Albert Anděl)" />
        </div>

        <div style="height:10px"></div>
        <div class="row">
          <button class="btn blue" id="btnStoreIn">VSTUP NA<br/>PRODEJNU</button>
          <button class="btn yellow" id="btnStoreOut">ODCHOD Z<br/>PRODEJNY</button>
        </div>

        <div class="divider"></div>

        <div class="exportBar">
          <button class="btn navy" id="btnExport">⬇ Stáhnout přehled (CSV)</button>
          <input class="month" id="monthPick" type="month" />
        </div>

        <div style="height:10px"></div>
        <div class="status" id="status">Stav: připraveno.</div>

        <div class="divider"></div>

        <div class="sectionTitle">DNEŠNÍ AKTIVITA</div>
        <div class="activity" id="activity"></div>

        <div class="tiny">
          Data jsou uložená jen v telefonu (localStorage). GPS funguje jen na HTTPS + s povolenou polohou.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead" id="modalTitle">Potvrzení</div>
      <div class="modalBody">
        <p class="modalMsg" id="modalMsg">--</p>
      </div>
      <div class="modalActions">
        <button class="btn green" id="modalYes">ANO</button>
        <button class="btn red" id="modalNo">NE</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ------------------ STORAGE MODEL ------------------
  // localStorage KEY -> { days: { "YYYY-MM-DD": DayRecord } }
  // DayRecord: { sessions: Session[] }
  // Session: { start: Point, end: Point|null, visits: Visit[] }
  // Visit: { storeName, in: Point, out: Point|null }
  // Point: { ts, lat, lon, acc }

  const STORAGE_KEY = "merchandiser_log_v2";

  const elNow = document.getElementById("nowText");
  const elPill = document.getElementById("modePill");
  const elStatus = document.getElementById("status");
  const elActivity = document.getElementById("activity");

  const btnShiftStart = document.getElementById("btnShiftStart");
  const btnShiftEnd = document.getElementById("btnShiftEnd");
  const btnStoreIn = document.getElementById("btnStoreIn");
  const btnStoreOut = document.getElementById("btnStoreOut");
  const btnExport = document.getElementById("btnExport");
  const inpStore = document.getElementById("storeName");
  const monthPick = document.getElementById("monthPick");

  // modal
  const modalBack = document.getElementById("modalBack");
  const modalMsg = document.getElementById("modalMsg");
  const modalYes = document.getElementById("modalYes");
  const modalNo = document.getElementById("modalNo");

  const pad2 = (n) => String(n).padStart(2, "0");

  function fmtDate(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function fmtTime(ts){
    const d = new Date(ts);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function fmtDateTime(ts){ return `${fmtDate(ts)} ${fmtTime(ts)}`; }

  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { days:{} };
      const data = JSON.parse(raw);
      if(!data || typeof data !== "object") return { days:{} };
      if(!data.days || typeof data.days !== "object") data.days = {};
      return data;
    }catch{
      return { days:{} };
    }
  }
  function save(data){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function getDay(data, key){
    if(!data.days[key]) data.days[key] = { sessions: [] };
    if(!Array.isArray(data.days[key].sessions)) data.days[key].sessions = [];
    return data.days[key];
  }

  function setStatus(msg){
    elStatus.textContent = "Stav: " + msg;
  }

  // ------------------ CONFIRM MODAL ------------------
  function confirmAction(message){
    return new Promise((resolve) => {
      modalMsg.textContent = message;
      modalBack.style.display = "flex";
      modalBack.setAttribute("aria-hidden","false");

      const cleanup = () => {
        modalBack.style.display = "none";
        modalBack.setAttribute("aria-hidden","true");
        modalYes.onclick = null;
        modalNo.onclick = null;
      };

      modalYes.onclick = () => { cleanup(); resolve(true); };
      modalNo.onclick  = () => { cleanup(); resolve(false); };

      // klik mimo modal = NE
      modalBack.onclick = (e) => {
        if(e.target === modalBack){
          cleanup(); resolve(false);
        }
      };
    });
  }

  // ------------------ GEO ------------------
  function getGeo(){
    return new Promise((resolve) => {
      if(!navigator.geolocation){
        resolve({ ok:false, err:"Geolocation není podporovaný." });
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({
          ok:true,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy
        }),
        (err) => resolve({ ok:false, err: err?.message || "GPS chyba" }),
        { enableHighAccuracy:true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  async function capturePoint(){
    const ts = Date.now();
    const geo = await getGeo();
    return {
      ts,
      lat: geo.ok ? geo.lat : null,
      lon: geo.ok ? geo.lon : null,
      acc: geo.ok ? geo.acc : null,
      geoOk: geo.ok,
      geoErr: geo.ok ? null : geo.err
    };
  }

  // ------------------ HELPERS ------------------
  function minutesDiff(aTs, bTs){
    if(aTs == null || bTs == null) return null;
    if(bTs < aTs) return null;
    return Math.floor((bTs - aTs) / 60000);
  }
  function hm(min){
    if(min == null) return "";
    const h = Math.floor(min/60);
    const m = min%60;
    return `${h} h ${pad2(m)} m`;
  }

  function activeSession(day){
    const s = day.sessions;
    if(!s.length) return null;
    const last = s[s.length-1];
    if(last && last.start && !last.end) return last;
    return null;
  }
  function activeVisit(session){
    if(!session) return null;
    const v = session.visits || [];
    if(!v.length) return null;
    const last = v[v.length-1];
    if(last && last.in && !last.out) return last;
    return null;
  }

  function gpsText(p){
    const has = (p?.lat != null && p?.lon != null);
    if(!has) return "bez GPS";
    const acc = (p.acc != null) ? `±${Math.round(p.acc)}m` : "±?";
    return `${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} (${acc})`;
  }

  function lockUI(lock){
    btnShiftStart.disabled = lock;
    btnShiftEnd.disabled = lock;
    btnStoreIn.disabled = lock;
    btnStoreOut.disabled = lock;
    btnExport.disabled = lock;
    inpStore.disabled = lock;
    monthPick.disabled = lock;
  }

  // ------------------ ACTIONS ------------------
  async function startShift(){
    const ok = await confirmAction("Přejete si potvrdit příchod do práce?");
    if(!ok) return;

    const data = load();
    const day = getDay(data, todayKey());

    const sActive = activeSession(day);
    if(sActive){
      setStatus("směna už běží (nejdřív dej odchod).");
      render();
      return;
    }

    lockUI(true);
    setStatus("ukládám příchod…");

    const p = await capturePoint();
    day.sessions.push({ start: { ts:p.ts, lat:p.lat, lon:p.lon, acc:p.acc }, end: null, visits: [] });
    save(data);

    setStatus(p.geoOk ? "příchod uložen ✅ (s GPS)" : `příchod uložen ✅ (bez GPS: ${p.geoErr})`);
    lockUI(false);
    render();
  }

  async function endShift(){
    const ok = await confirmAction("Přejete si potvrdit odchod z práce?");
    if(!ok) return;

    const data = load();
    const day = getDay(data, todayKey());
    const s = activeSession(day);

    if(!s){
      setStatus("žádná směna neběží.");
      render();
      return;
    }
    if(activeVisit(s)){
      setStatus("nejdřív ukonči návštěvu prodejny.");
      alert("Nejdřív ukonči návštěvu prodejny (odchod z prodejny).");
      render();
      return;
    }

    lockUI(true);
    setStatus("ukládám odchod…");

    const p = await capturePoint();
    s.end = { ts:p.ts, lat:p.lat, lon:p.lon, acc:p.acc };
    save(data);

    const workMin = minutesDiff(s.start?.ts, s.end?.ts);
    setStatus(p.geoOk ? `odchod uložen ✅ (celkem ${hm(workMin)})` : `odchod uložen ✅ (bez GPS: ${p.geoErr})`);
    lockUI(false);
    render();
  }

  async function storeIn(){
    const data = load();
    const day = getDay(data, todayKey());
    const s = activeSession(day);

    if(!s){
      alert("Nejdřív zahaj směnu (Příchod).");
      return;
    }
    if(activeVisit(s)){
      alert("Už máš aktivní návštěvu. Nejdřív dej odchod z prodejny.");
      return;
    }

    const name = (inpStore.value || "").trim();
    if(!name){
      alert("Zadej název prodejny.");
      inpStore.focus();
      return;
    }

    const ok = await confirmAction(`Přejete si potvrdit VSTUP na prodejnu?\n\nProdejna: ${name}`);
    if(!ok) return;

    lockUI(true);
    setStatus("ukládám vstup na prodejnu…");

    const p = await capturePoint();
    s.visits = Array.isArray(s.visits) ? s.visits : [];
    s.visits.push({
      storeName: name,
      in: { ts:p.ts, lat:p.lat, lon:p.lon, acc:p.acc },
      out: null
    });
    save(data);

    setStatus(p.geoOk ? "vstup uložen ✅ (s GPS)" : `vstup uložen ✅ (bez GPS: ${p.geoErr})`);
    lockUI(false);
    render();
  }

  async function storeOut(){
    const data = load();
    const day = getDay(data, todayKey());
    const s = activeSession(day);

    if(!s){
      alert("Nejdřív zahaj směnu (Příchod).");
      return;
    }

    const v = activeVisit(s);
    if(!v){
      alert("Žádná aktivní návštěva není otevřená.");
      return;
    }

    const ok = await confirmAction(`Přejete si potvrdit ODCHOD z prodejny?\n\nProdejna: ${v.storeName || "(bez názvu)"}`);
    if(!ok) return;

    lockUI(true);
    setStatus("ukládám odchod z prodejny…");

    const p = await capturePoint();
    v.out = { ts:p.ts, lat:p.lat, lon:p.lon, acc:p.acc };
    save(data);

    const vMin = minutesDiff(v.in?.ts, v.out?.ts);
    setStatus(p.geoOk ? `odchod uložen ✅ (návštěva ${hm(vMin)})` : `odchod uložen ✅ (bez GPS: ${p.geoErr})`);
    lockUI(false);
    render();
  }

  // ------------------ EXPORT CSV ------------------
  function monthRange(y, m){
    const from = new Date(y, m-1, 1, 0,0,0,0).getTime();
    const to = new Date(y, m, 0, 23,59,59,999).getTime();
    return { from, to };
  }
  function parseMonthValue(v){
    if(!v) return null;
    const [y,m] = v.split("-").map(Number);
    if(!y || !m) return null;
    return { y, m };
  }
  function csvEscape(value, sep){
    const s = String(value ?? "");
    const needs = s.includes(sep) || s.includes('"') || s.includes("\n");
    const v = s.replaceAll('"','""');
    return needs ? `"${v}"` : v;
  }

  function exportCsv(){
    const data = load();
    const sel = parseMonthValue(monthPick.value);
    if(!sel){
      alert("Vyber měsíc pro export.");
      return;
    }

    const sep = ","; // xlsx friendly (BOM + comma)
    const { from, to } = monthRange(sel.y, sel.m);

    const dayKeys = Object.keys(data.days || {})
      .filter(k => {
        const [yy,mm,dd] = k.split("-").map(Number);
        if(!yy || !mm || !dd) return false;
        const ts = new Date(yy, mm-1, dd, 12,0,0,0).getTime();
        return ts >= from && ts <= to;
      })
      .sort((a,b) => a.localeCompare(b));

    const head = [
      "row_type",
      "date",
      "day_work_minutes",
      "day_visit_count",

      "session_index",
      "session_start",
      "session_start_lat",
      "session_start_lon",
      "session_end",
      "session_end_lat",
      "session_end_lon",
      "session_work_minutes",
      "session_visit_count",

      "visit_index",
      "store_name",
      "store_in",
      "store_in_lat",
      "store_in_lon",
      "store_out",
      "store_out_lat",
      "store_out_lon",
      "visit_minutes"
    ];

    const lines = [];
    lines.push(head.join(sep));

    for(const dk of dayKeys){
      const day = getDay(data, dk);
      const sessions = Array.isArray(day.sessions) ? day.sessions : [];

      // totals
      let dayWorkMin = 0;
      let dayHasAnyEndedSession = false;
      let dayVisitCount = 0;

      for(const s of sessions){
        const sc = Array.isArray(s.visits) ? s.visits.length : 0;
        dayVisitCount += sc;

        if(s.start?.ts && s.end?.ts){
          const wm = minutesDiff(s.start.ts, s.end.ts);
          if(wm != null){
            dayWorkMin += wm;
            dayHasAnyEndedSession = true;
          }
        }
      }

      // DAY_TOTAL row
      lines.push([
        "DAY_TOTAL",
        dk,
        dayHasAnyEndedSession ? dayWorkMin : "",
        dayVisitCount,

        "",
        "", "", "",
        "", "", "",
        "", "",

        "",
        "",
        "", "", "",
        "", "", "",
        ""
      ].map(x => csvEscape(x, sep)).join(sep));

      // SESSION rows + VISIT rows
      sessions.forEach((s, si) => {
        const sStartTs = s.start?.ts ?? null;
        const sEndTs = s.end?.ts ?? null;
        const sWorkMin = (sStartTs && sEndTs) ? minutesDiff(sStartTs, sEndTs) : null;
        const vList = Array.isArray(s.visits) ? s.visits : [];
        const sVisitCount = vList.length;

        lines.push([
          "SESSION",
          dk,
          "",
          "",

          (si+1),
          sStartTs ? fmtDateTime(sStartTs) : "",
          s.start?.lat ?? "",
          s.start?.lon ?? "",
          sEndTs ? fmtDateTime(sEndTs) : "",
          s.end?.lat ?? "",
          s.end?.lon ?? "",
          sWorkMin ?? "",
          sVisitCount,

          "",
          "",
          "", "", "",
          "", "", "",
          ""
        ].map(x => csvEscape(x, sep)).join(sep));

        vList.forEach((v, vi) => {
          const vInTs = v?.in?.ts ?? null;
          const vOutTs = v?.out?.ts ?? null;
          const vMin = (vInTs && vOutTs) ? minutesDiff(vInTs, vOutTs) : null;

          lines.push([
            "VISIT",
            dk,
            "",
            "",

            (si+1),
            sStartTs ? fmtDateTime(sStartTs) : "",
            s.start?.lat ?? "",
            s.start?.lon ?? "",
            sEndTs ? fmtDateTime(sEndTs) : "",
            s.end?.lat ?? "",
            s.end?.lon ?? "",
            sWorkMin ?? "",
            sVisitCount,

            (vi+1),
            v?.storeName ?? "",
            vInTs ? fmtDateTime(vInTs) : "",
            v?.in?.lat ?? "",
            v?.in?.lon ?? "",
            vOutTs ? fmtDateTime(vOutTs) : "",
            v?.out?.lat ?? "",
            v?.out?.lon ?? "",
            vMin ?? ""
          ].map(x => csvEscape(x, sep)).join(sep));
        });
      });
    }

    const csv = "\uFEFF" + lines.join("\n"); // BOM pro Excel (UTF-8)
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const fname = `merchandiser_log_${sel.y}_${pad2(sel.m)}.csv`;
    const a = document.createElement("a");
    a.href = url;
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setStatus("export hotovej ✅");
  }

  // ------------------ RENDER ------------------
  function updateNow(){
    const d = new Date();
    elNow.textContent = `${d.getDate()}. ${d.getMonth()+1}. ${d.getFullYear()}  ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function render(){
    updateNow();

    const data = load();
    const day = getDay(data, todayKey());

    const s = activeSession(day);
    const v = activeVisit(s);

    // pill
    if(!s) elPill.textContent = "MIMO PRACOVNÍ DOBU";
    else if(s && v) elPill.textContent = "NA PRODEJNĚ";
    else elPill.textContent = "VE SMĚNĚ";

    // button enable logic + requested behavior
    // Příchod: permanentně zelené, aktivní jen když není session aktivní
    btnShiftStart.disabled = !!s;

    // Odchod: červené aktivní jen když session běží
    btnShiftEnd.disabled = !s;

    // Store buttons:
    btnStoreIn.disabled = !s || !!v;
    btnStoreOut.disabled = !s || !v;

    // Activity view (flatten sessions + visits)
    const items = [];

    const sessions = Array.isArray(day.sessions) ? day.sessions : [];
    sessions.forEach((sess, i) => {
      items.push({
        tag: `SMĚNA #${i+1}`,
        title: "Příchod",
        sub: `${sess.start?.ts ? fmtDateTime(sess.start.ts) : "—"} • GPS: ${gpsText(sess.start)}`
      });

      const vList = Array.isArray(sess.visits) ? sess.visits : [];
      vList.forEach((vv, j) => {
        const inTs = vv?.in?.ts;
        const outTs = vv?.out?.ts;
        const dur = (inTs && outTs) ? hm(minutesDiff(inTs, outTs)) : (inTs ? "probíhá…" : "");
        items.push({
          tag: `PRODEJNA ${i+1}.${j+1}`,
          title: vv?.storeName || "(bez názvu)",
          sub: `${inTs ? fmtDateTime(inTs) : "—"} → ${outTs ? fmtDateTime(outTs) : "—"} • ${dur}`
        });
      });

      if(sess.end?.ts){
        const w = minutesDiff(sess.start?.ts, sess.end.ts);
        items.push({
          tag: `SMĚNA #${i+1}`,
          title: "Odchod",
          sub: `${fmtDateTime(sess.end.ts)} • Celkem: ${hm(w)}`
        });
      } else {
        items.push({
          tag: `SMĚNA #${i+1}`,
          title: "Běží…",
          sub: "Směna není uzavřená (čeká na Odchod)."
        });
      }
    });

    if(!items.length){
      elActivity.innerHTML = `<div class="tiny">Zatím nic. Klikni na PŘÍCHOD.</div>`;
    } else {
      elActivity.innerHTML = items.map(it => `
        <div class="item">
          <div class="itemTop">
            <div>
              <p class="itemTitle">${escapeHtml(it.title)}</p>
              <p class="itemSub mono">${escapeHtml(it.sub)}</p>
            </div>
            <div class="tag">${escapeHtml(it.tag)}</div>
          </div>
        </div>
      `).join("");
    }

    // month default
    if(!monthPick.value){
      const n = new Date();
      monthPick.value = `${n.getFullYear()}-${pad2(n.getMonth()+1)}`;
    }
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  // ------------------ WIRE ------------------
  btnShiftStart.addEventListener("click", startShift);
  btnShiftEnd.addEventListener("click", endShift);
  btnStoreIn.addEventListener("click", storeIn);
  btnStoreOut.addEventListener("click", storeOut);
  btnExport.addEventListener("click", exportCsv);

  // service worker register + auto update
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        const reg = await navigator.serviceWorker.register("./sw.js");
        reg.update();
        reg.addEventListener("updatefound", () => {
          const nw = reg.installing;
          if(!nw) return;
          nw.addEventListener("statechange", () => {
            if (nw.state === "activated") location.reload();
          });
        });
      } catch {}
    });
  }

  // tick
  render();
  setInterval(updateNow, 1000);

})();
</script>
</body>
</html>

