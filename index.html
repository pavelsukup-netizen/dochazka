<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MERCHANDISER LOG</title>
  <meta name="theme-color" content="#4f46e5" />
  <style>
    :root{
      --bg:#eef2f7;
      --card:#ffffff;
      --shadow:0 18px 40px rgba(15, 23, 42, .14);
      --text:#0f172a;
      --muted:#64748b;

      --brand:#4f46e5;      /* fialová hlavička */
      --brandDark:#4338ca;

      --btnGreen:#16a34a;
      --btnGreenDark:#15803d;

      --btnGray:#9ca3af;
      --btnGrayDark:#6b7280;

      --btnNavy:#1f2937;
      --btnNavyDark:#111827;

      --pill:#1e293b;
      --line:#e5e7eb;

      --radius:18px;
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      display:flex;
      justify-content:center;
      padding:24px 14px;
    }

    .phone {
      width: min(430px, 100%);
    }

    .card{
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.06);
    }

    .header{
      background: var(--brand);
      padding: 22px 18px 18px;
      text-align:center;
      color:#fff;
    }

    .title{
      font-weight: 900;
      letter-spacing: .5px;
      font-size: 22px;
      margin:0 0 8px;
    }

    .now{
      margin:0;
      opacity:.95;
      font-weight: 700;
      font-size: 14px;
    }

    .pill{
      display:inline-block;
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,.35);
      border: 1px solid rgba(255,255,255,.25);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .25px;
      text-transform: uppercase;
    }

    .content{
      padding: 16px 18px 18px;
    }

    .sectionTitle{
      font-size: 12px;
      font-weight: 900;
      color: #7c8697;
      letter-spacing: 1px;
      margin: 10px 2px 10px;
      text-transform: uppercase;
    }

    .row{
      display:flex;
      gap: 14px;
    }

    .btn{
      border:0;
      border-radius: 12px;
      padding: 14px 12px;
      font-weight: 900;
      font-size: 15px;
      width:100%;
      color:#fff;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(2,6,23,.10);
      transition: transform .05s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    .green{ background: var(--btnGreen); }
    .green:hover{ filter: brightness(.98); }
    .green:active{ background: var(--btnGreenDark); }

    .gray{ background: var(--btnGray); }
    .gray:active{ background: var(--btnGrayDark); }

    .navy{ background: var(--btnNavy); }
    .navy:active{ background: var(--btnNavyDark); }

    .divider{
      height:1px;
      background: var(--line);
      margin: 14px 0;
    }

    .fieldRow{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 6px;
    }

    .input{
      width:100%;
      border-radius: 12px;
      border: 1px solid #d8dee9;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    .input:focus{
      border-color: rgba(79,70,229,.45);
      box-shadow: 0 0 0 3px rgba(79,70,229,.15);
    }

    .metaRow{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    .status{
      padding: 10px 12px;
      background: #f8fafc;
      border: 1px solid #e7edf6;
      border-radius: 14px;
      font-size: 12px;
      color: #334155;
      font-weight: 700;
    }

    .activity{
      margin-top: 10px;
      padding-bottom: 6px;
    }

    .item{
      border: 1px solid #e7edf6;
      background: #fbfdff;
      border-radius: 14px;
      padding: 10px 12px;
      margin-top: 8px;
    }

    .itemTop{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:flex-start;
    }

    .tag{
      font-weight: 900;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(79,70,229,.10);
      color: var(--brandDark);
      white-space:nowrap;
    }

    .itemTitle{
      font-weight: 900;
      font-size: 14px;
      margin:0;
    }

    .itemSub{
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .tiny{ font-size: 11px; color: var(--muted); font-weight: 700; }

    .exportBar{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 8px;
    }

    .month{
      width: 150px;
      min-width: 150px;
      border-radius: 12px;
      border: 1px solid #d8dee9;
      padding: 12px 10px;
      font-weight: 800;
      font-size: 13px;
      background:#fff;
      color: var(--text);
      outline:none;
    }

    .icon{
      display:inline-block;
      transform: translateY(1px);
      margin-right: 8px;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="card">
      <div class="header">
        <h1 class="title">MERCHANDISER LOG</h1>
        <p class="now mono" id="nowText">--</p>
        <div class="pill" id="modePill">MIMO PRACOVNÍ DOBU</div>
      </div>

      <div class="content">
        <div class="sectionTitle">PRACOVNÍ SMĚNA</div>
        <div class="row">
          <button class="btn green" id="btnShiftStart">PŘÍCHOD</button>
          <button class="btn gray" id="btnShiftEnd">ODCHOD</button>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">NÁVŠTĚVA PRODEJNY</div>

        <div class="fieldRow">
          <input class="input" id="storeName" placeholder="Název prodejny (např. Albert Anděl)" />
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button class="btn gray" id="btnStoreIn">VSTUP NA<br/>PRODEJNU</button>
          <button class="btn gray" id="btnStoreOut">ODCHOD Z<br/>PRODEJNY</button>
        </div>

        <div class="divider"></div>

        <div class="exportBar">
          <button class="btn navy" id="btnExport">
            <span class="icon">⬇</span>Stáhnout přehled (CSV)
          </button>
          <input class="month" id="monthPick" type="month" />
        </div>

        <div style="height:10px"></div>
        <div class="status" id="status">Stav: připraveno.</div>

        <div class="divider"></div>

        <div class="sectionTitle">DNEŠNÍ AKTIVITA</div>
        <div class="activity" id="activity"></div>

        <div class="tiny">
          Data jsou uložená jen v telefonu (localStorage). GPS funguje jen na HTTPS + s povolenou polohou.
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ------------------ STORAGE MODEL ------------------
  // localStorage KEY -> { days: { "YYYY-MM-DD": DayRecord } }
  // DayRecord: {
  //   shiftStart: {ts, lat, lon, acc} | null,
  //   shiftEnd:   {ts, lat, lon, acc} | null,
  //   visits: [ { storeName, in:{...}, out:{...}|null } ]
  // }

  const STORAGE_KEY = "merchandiser_log_v1";

  const elNow = document.getElementById("nowText");
  const elPill = document.getElementById("modePill");
  const elStatus = document.getElementById("status");
  const elActivity = document.getElementById("activity");

  const btnShiftStart = document.getElementById("btnShiftStart");
  const btnShiftEnd = document.getElementById("btnShiftEnd");
  const btnStoreIn = document.getElementById("btnStoreIn");
  const btnStoreOut = document.getElementById("btnStoreOut");
  const btnExport = document.getElementById("btnExport");
  const inpStore = document.getElementById("storeName");
  const monthPick = document.getElementById("monthPick");

  const pad2 = (n) => String(n).padStart(2, "0");

  function fmtDate(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function fmtTime(ts){
    const d = new Date(ts);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function fmtDateTime(ts){ return `${fmtDate(ts)} ${fmtTime(ts)}`; }

  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { days:{} };
      const data = JSON.parse(raw);
      if(!data || typeof data !== "object") return { days:{} };
      if(!data.days || typeof data.days !== "object") data.days = {};
      return data;
    }catch{
      return { days:{} };
    }
  }
  function save(data){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function getDay(data, key){
    if(!data.days[key]){
      data.days[key] = { shiftStart:null, shiftEnd:null, visits:[] };
    }
    if(!Array.isArray(data.days[key].visits)) data.days[key].visits = [];
    return data.days[key];
  }

  function setStatus(msg){
    elStatus.textContent = "Stav: " + msg;
  }

  // ------------------ GEO ------------------
  function getGeo(){
    return new Promise((resolve) => {
      if(!navigator.geolocation){
        resolve({ ok:false, err:"Geolocation není podporovaný." });
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({
          ok:true,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy
        }),
        (err) => resolve({ ok:false, err: err?.message || "GPS chyba" }),
        { enableHighAccuracy:true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  async function capturePoint(){
    const ts = Date.now();
    const geo = await getGeo();
    return {
      ts,
      lat: geo.ok ? geo.lat : null,
      lon: geo.ok ? geo.lon : null,
      acc: geo.ok ? geo.acc : null,
      geoOk: geo.ok,
      geoErr: geo.ok ? null : geo.err
    };
  }

  // ------------------ STATE DERIVED ------------------
  function isShiftActive(day){
    return !!(day.shiftStart && !day.shiftEnd);
  }
  function activeVisit(day){
    if(!day.visits.length) return null;
    const last = day.visits[day.visits.length-1];
    if(last && last.in && !last.out) return last;
    return null;
  }

  function minutesDiff(aTs, bTs){
    if(aTs == null || bTs == null) return null;
    if(bTs < aTs) return null;
    return Math.floor((bTs - aTs) / 60000);
  }
  function hm(min){
    if(min == null) return "";
    const h = Math.floor(min/60);
    const m = min%60;
    return `${h} h ${pad2(m)} m`;
  }

  // ------------------ ACTIONS ------------------
  async function startShift(){
    const data = load();
    const day = getDay(data, todayKey());

    if(isShiftActive(day)){
      setStatus("už jsi ve směně.");
      return;
    }
    if(day.shiftStart && day.shiftEnd){
      // nový shift stejný den? necháme to jako 1 směnu/den (typicky docházka).
      // když chceš více směn, dá se to rozšířit – zatím radši zabráníme chaosu.
      alert("Dnešní směna už je uzavřená. Pokud potřebuješ druhou směnu v jednom dni, řekni a rozšíříme logiku.");
      return;
    }

    lockUI(true);
    setStatus("ukládám příchod…");

    const p = await capturePoint();
    day.shiftStart = { ts:p.ts, lat:p.lat, lon:p.lon, acc:p.acc };
    save(data);

    setStatus(p.geoOk ? "příchod uložen ✅ (s GPS)" : `příchod uložen ✅ (bez GPS: ${p.geoErr})`);
    lockUI(false);
    render();
  }

  async function endShift(){
    const data = load();
    const day = getDay(data, todayKey());

    if(!isShiftActive(day)){
      setStatus("směna není aktivní.");
      return;
    }
    if(activeVisit(day)){
      alert("Nejdřív ukonči návštěvu prodejny (odchod z prodejny).");
      return;
    }

    lockUI(true);
    setStatus("ukládám odchod…");

    const p = await capturePoint();
    day.shiftEnd = { ts:p.ts, lat:p.lat, lon:p.lon, acc:p.acc };
    save(data);

    setStatus(p.geoOk ? "odchod uložen ✅ (s GPS)" : `odchod uložen ✅ (bez GPS: ${p.geoErr})`);
    lockUI(false);
    render();
  }

  async function storeIn(){
    const name = (inpStore.value || "").trim();
    if(!name){
      alert("Zadej název prodejny.");
      inpStore.focus();
      return;
    }

    const data = load();
    const day = getDay(data, todayKey());

    if(!isShiftActive(day)){
      alert("Nejdřív zahaj směnu (Příchod).");
      return;
    }
    if(activeVisit(day)){
      alert("Už máš aktivní návštěvu. Nejdřív dej odchod z prodejny.");
      return;
    }

    lockUI(true);
    setStatus("ukládám vstup na prodejnu…");

    const p = await capturePoint();
    day.visits.push({
      storeName: name,
      in: { ts:p.ts, lat:p.lat, lon:p.lon, acc:p.acc },
      out: null
    });
    save(data);

    setStatus(p.geoOk ? "vstup uložen ✅ (s GPS)" : `vstup uložen ✅ (bez GPS: ${p.geoErr})`);
    lockUI(false);
    render();
  }

  async function storeOut(){
    const data = load();
    const day = getDay(data, todayKey());

    if(!isShiftActive(day)){
      alert("Nejdřív zahaj směnu (Příchod).");
      return;
    }

    const v = activeVisit(day);
    if(!v){
      alert("Žádná aktivní návštěva není otevřená.");
      return;
    }

    lockUI(true);
    setStatus("ukládám odchod z prodejny…");

    const p = await capturePoint();
    v.out = { ts:p.ts, lat:p.lat, lon:p.lon, acc:p.acc };
    save(data);

    setStatus(p.geoOk ? "odchod z prodejny uložen ✅ (s GPS)" : `odchod z prodejny uložen ✅ (bez GPS: ${p.geoErr})`);
    lockUI(false);
    render();
  }

  function lockUI(lock){
    btnShiftStart.disabled = lock;
    btnShiftEnd.disabled = lock;
    btnStoreIn.disabled = lock;
    btnStoreOut.disabled = lock;
    btnExport.disabled = lock;
    inpStore.disabled = lock;
    monthPick.disabled = lock;
  }

  // ------------------ EXPORT CSV ------------------
  function monthRange(y, m){
    const from = new Date(y, m-1, 1, 0,0,0,0).getTime();
    const to = new Date(y, m, 0, 23,59,59,999).getTime();
    return { from, to };
  }

  function parseMonthValue(v){
    if(!v) return null;
    const [y,m] = v.split("-").map(Number);
    if(!y || !m) return null;
    return { y, m };
  }

  function csvEscape(value, sep){
    const s = String(value ?? "");
    const needs = s.includes(sep) || s.includes('"') || s.includes("\n");
    const v = s.replaceAll('"','""');
    return needs ? `"${v}"` : v;
  }

  function exportCsv(){
    const data = load();
    const sel = parseMonthValue(monthPick.value);
    if(!sel){
      alert("Vyber měsíc pro export.");
      return;
    }

    const sep = ","; // chceš xlsx friendly – čárka; (když budeš chtít ; pro CZ Excel, řekni a přepnu)
    const { from, to } = monthRange(sel.y, sel.m);

    // vyber dny v rozsahu
    const dayKeys = Object.keys(data.days || {})
      .filter(k => {
        // k je YYYY-MM-DD, vytvoříme timestamp na začátku dne
        const [yy,mm,dd] = k.split("-").map(Number);
        if(!yy || !mm || !dd) return false;
        const ts = new Date(yy, mm-1, dd, 12,0,0,0).getTime(); // poledne kvůli DST
        return ts >= from && ts <= to;
      })
      .sort((a,b) => a.localeCompare(b));

    const head = [
      "row_type",
      "date",
      "shift_start",
      "shift_start_lat",
      "shift_start_lon",
      "shift_end",
      "shift_end_lat",
      "shift_end_lon",
      "work_minutes",
      "visit_count",
      "visit_index",
      "store_name",
      "store_in",
      "store_in_lat",
      "store_in_lon",
      "store_out",
      "store_out_lat",
      "store_out_lon",
      "visit_minutes"
    ];

    const lines = [];
    lines.push(head.join(sep));

    for(const dk of dayKeys){
      const day = getDay(data, dk);
      const visitCount = (day.visits || []).length;

      const shiftStartTs = day.shiftStart?.ts ?? null;
      const shiftEndTs = day.shiftEnd?.ts ?? null;
      const workMin = (shiftStartTs && shiftEndTs) ? minutesDiff(shiftStartTs, shiftEndTs) : null;

      // 1) řádek dne – souhrn
      lines.push([
        "DAY_TOTAL",
        dk,
        shiftStartTs ? fmtDateTime(shiftStartTs) : "",
        day.shiftStart?.lat ?? "",
        day.shiftStart?.lon ?? "",
        shiftEndTs ? fmtDateTime(shiftEndTs) : "",
        day.shiftEnd?.lat ?? "",
        day.shiftEnd?.lon ?? "",
        workMin ?? "",
        visitCount,
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        ""
      ].map(x => csvEscape(x, sep)).join(sep));

      // 2) řádky návštěv
      for(let i=0; i<visitCount; i++){
        const v = day.visits[i];
        const vInTs = v?.in?.ts ?? null;
        const vOutTs = v?.out?.ts ?? null;
        const vMin = (vInTs && vOutTs) ? minutesDiff(vInTs, vOutTs) : null;

        lines.push([
          "VISIT",
          dk,
          shiftStartTs ? fmtDateTime(shiftStartTs) : "",
          day.shiftStart?.lat ?? "",
          day.shiftStart?.lon ?? "",
          shiftEndTs ? fmtDateTime(shiftEndTs) : "",
          day.shiftEnd?.lat ?? "",
          day.shiftEnd?.lon ?? "",
          workMin ?? "",
          visitCount,
          (i+1),
          v?.storeName ?? "",
          vInTs ? fmtDateTime(vInTs) : "",
          v?.in?.lat ?? "",
          v?.in?.lon ?? "",
          vOutTs ? fmtDateTime(vOutTs) : "",
          v?.out?.lat ?? "",
          v?.out?.lon ?? "",
          vMin ?? ""
        ].map(x => csvEscape(x, sep)).join(sep));
      }

      // když nejsou návštěvy, necháme jen DAY_TOTAL (to je ok)
    }

    const csv = "\uFEFF" + lines.join("\n"); // BOM pro Excel (UTF-8)
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const fname = `merchandiser_log_${sel.y}_${pad2(sel.m)}.csv`;
    const a = document.createElement("a");
    a.href = url;
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setStatus("export hotovej ✅");
  }

  // ------------------ RENDER ------------------
  function updateNow(){
    const d = new Date();
    elNow.textContent = `${d.getDate()}. ${d.getMonth()+1}. ${d.getFullYear()}  ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function render(){
    updateNow();

    const data = load();
    const day = getDay(data, todayKey());
    const shiftActive = isShiftActive(day);
    const vActive = activeVisit(day);

    // pill mode
    if(!shiftActive){
      elPill.textContent = "MIMO PRACOVNÍ DOBU";
    } else if(shiftActive && vActive){
      elPill.textContent = "NA PRODEJNĚ";
    } else {
      elPill.textContent = "VE SMĚNĚ";
    }

    // buttons state
    btnShiftStart.classList.toggle("green", !shiftActive && !day.shiftStart);
    btnShiftStart.classList.toggle("gray", shiftActive || !!day.shiftStart);
    btnShiftStart.disabled = shiftActive || !!day.shiftStart;

    btnShiftEnd.disabled = !shiftActive;
    btnShiftEnd.classList.toggle("gray", true);

    // store buttons
    const canStore = shiftActive;
    btnStoreIn.disabled = !canStore || !!vActive;
    btnStoreOut.disabled = !canStore || !vActive;

    // input lock during active visit
    inpStore.disabled = !!vActive ? true : false;
    if(vActive) inpStore.value = vActive.storeName || inpStore.value;

    // activity view
    const items = [];

    if(day.shiftStart){
      items.push({
        tag:"SMĚNA",
        title:"Příchod",
        sub: `${fmtDateTime(day.shiftStart.ts)} • GPS: ${gpsText(day.shiftStart)}`
      });
    }
    if(day.visits?.length){
      day.visits.forEach((v, idx) => {
        const inTs = v?.in?.ts;
        const outTs = v?.out?.ts;
        const dur = (inTs && outTs) ? hm(minutesDiff(inTs, outTs)) : (inTs ? "probíhá…" : "");
        items.push({
          tag:`PRODEJNA #${idx+1}`,
          title: v.storeName || "(bez názvu)",
          sub: `${inTs ? fmtDateTime(inTs) : "—"} → ${outTs ? fmtDateTime(outTs) : "—"} • ${dur}`
        });
      });
    }
    if(day.shiftEnd){
      const workMin = minutesDiff(day.shiftStart?.ts ?? null, day.shiftEnd.ts);
      items.push({
        tag:"SMĚNA",
        title:"Odchod",
        sub: `${fmtDateTime(day.shiftEnd.ts)} • Celkem práce: ${hm(workMin)}`
      });
    }

    if(!items.length){
      elActivity.innerHTML = `<div class="tiny">Zatím nic. Zahaj směnu (Příchod).</div>`;
    } else {
      elActivity.innerHTML = items.map(it => `
        <div class="item">
          <div class="itemTop">
            <div>
              <p class="itemTitle">${escapeHtml(it.title)}</p>
              <p class="itemSub mono">${escapeHtml(it.sub)}</p>
            </div>
            <div class="tag">${escapeHtml(it.tag)}</div>
          </div>
        </div>
      `).join("");
    }

    // měsíční picker default (když je prázdný)
    if(!monthPick.value){
      const n = new Date();
      monthPick.value = `${n.getFullYear()}-${pad2(n.getMonth()+1)}`;
    }
  }

  function gpsText(p){
    const has = (p.lat != null && p.lon != null);
    if(!has) return "bez GPS";
    const acc = (p.acc != null) ? `±${Math.round(p.acc)}m` : "±?";
    return `${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} (${acc})`;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  // ------------------ WIRE UP ------------------
  btnShiftStart.addEventListener("click", startShift);
  btnShiftEnd.addEventListener("click", endShift);
  btnStoreIn.addEventListener("click", storeIn);
  btnStoreOut.addEventListener("click", storeOut);
  btnExport.addEventListener("click", exportCsv);
  monthPick.addEventListener("change", () => setStatus("měsíc vybrán."));

  // tick
  render();
  setInterval(updateNow, 1000);

})();
</script>
</body>
</html>
